apiVersion: v1
kind: Service
metadata:
  namespace: infra
  name: promtail
  labels:
    app: promtail
spec:
  selector:
    app: promtail
  ports:
  - protocol: TCP
    port: 9080
    targetPort: 9080
  type: NodePort
  # nodePort: 30002
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: infra
  name: promtail
  labels:
    app: promtail
data:
  positions.yaml: |
    # gets updated by promtail
  promtail.yaml: |
    # scrape configurations
    server:
      http_listen_port: 9080
    target_config:
      sync_period: 10s
      scrape_configs:
      - job_name: kubernetes-pods
        pipeline_stages:
        - docker: {}  # optional
        - match:
            # filter by app label
            selector:
              app: "backend"
        stages:
        - parser: json
          expressions:
            message: '{message}'
            timestamp: '{time}' # adjust for log format
        relabel_configs:
        - source_labels: ['__meta_kubernetes_pod_label_<name>']
          target_label: '{{__meta_kubernetes_pod_label_<name>}}'
        kubernetes_sd_configs:
        - role: pod
          # namespace filter for pods
          namespaces:
            names:
            - "live"
            - "test"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: infra
  name: promtail
spec:
  replicas: 1
  selector:
    matchLabels:
      app: promtail
  template:
    metadata:
      labels:
        app: promtail
    spec:
      containers:
      - name: promtail
        image: grafana/promtail:3.0.0
        resources:
          requests:
            memory: "100Mi"
            # cpu: "100m"
          limits:
            memory: "200Mi"
            # cpu: "200m"
        command:
        - "-write"
        - "loki:3100"
      volumes:
      - name: promtail-config
        configMap:
          name: promtail
